\def\OPTIONConf{0}%
\def\OPTIONArxiv{0}%
%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2018}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
\input{defs}

\begin{document}

%% Title information
\title[Short Title]{SaUCy}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{First1 Last1}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}                   %% \country is recommended
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}                   %% \country is recommended
}
\email{first2.last2@inst2b.org}         %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle


\section{Introduction}

Proving that a cryptographic protocol carries out a given task securely is an
essential component in cryptography. Traditionally, such a protocol is analyzed
in the \emph{standalone} setting, in which a single execution takes place in
isolation. In reality, however, the protocol may be running concurrently with
arbitrary other protocols, and indeed, security guarantees in the standalone
setting do not always translate into security guarantees in the concurrent
setting. In order to provide meaningful security guarantees in the concurrent
setting, the Universal Composability (UC) framework by
Canetti~\cite{canetti2001universally} allows the security properties of a
protocol to be defined in such a way that security is maintained under general
concurrent composition with arbitrary other protocols. In other words, a
UC-secure protocol maintains its security when dropped into \emph{any context}.
Importantly, this allows for complex cryptographic protocols to be designed and
analyzed in a modular fashion from simpler building blocks.

Since universally composable security is such a powerful guarantee, it is
perhaps not surprising that elaborating such proofs can be quite involved, and
thus, error-prone. However, as UC proofs are primarily ``pen-and-paper'' proofs,
this makes verifying them an unwieldy task. In addition, the numerous variations
of UC (e.g., guc~\cite{canetti2007universally},
juc~\cite{canetti2003universal}, symbolic UC~\cite{bohl2016symbolic},
RSIM~\cite{backes2007reactive}, GNUC~\cite{hofheinz2015gnuc}) make it hard to
keep track of the precise semantics of security claims. In this paper, we design
and implement a specialized programming language called the Interactive Lambda
Calculus (ILC) for building a concrete implementation of the UC framework, and
for elaborating algorithmic entities (i.e., ideal functionalities and
simulators) used in UC proofs. In particular, the type system of ILC enforces
that well-typed programs are confluent, i.e., they either diverge or evaluate
to a single unique value, which makes it easier to reason about
the \emph{indistinguishability} of two programs in ILC.
%pi calculus not confluent, pi calculus w/ session types too restrictive

\section{Overview}\label{sec:overview}

In order to prove that a cryptographic protocol carries out a given task
securely, we first formalize the protocol, henceforth referred to as the real
protocol, and its execution in the presence of an adversary and in a given
computational environment. We then formalize an ideal protocol that is secure by
definition for carrying out the task. In the ideal protocol, parties do not
communicate with each other, rather, they rely on an incorruptible trusted party
called the \emph{ideal functionality} to meet the requirements of the task at
hand. Finally, to show that the real protocol carries out the task securely, we
show that running it ``emulates'' running the ideal protocol for that task, in
the sense that an outside observer called the \emph{environment}, which
interacts with both the real and ideal protocols, cannot distinguish them apart.

As in~\cite{goldwasser1989knowledge}, a protocol is represented as a system of
interactive Turing machines (ITMs), in which each ITM represents the program to
be run within each party. Each ITM has an input and output tapes to model inputs
received from and outputs given to other ITMs. Additionally, each ITM has a
communication tape to model messages sent to and received from the network.

Let $\pi$ denote the real protocol followed by a set of parties, and let $\mc{A}$
denote an adversary that aims to break the security of $\pi$. If $\mc{A}$ is
a \emph{passive} (or \emph{semi-honest}) adversary, then it can listen to all
communications between the parties, and can observe the internal state of
corrupted parties. If $\mc{A}$ is an \emph{active} (or \emph{malicious})
adversary, then it can additionally take full control of parties and alter
messages en route arbitrarily. The adversary communicates with the environment
$\mc{Z}$ to provide details of what it observes, and also to receive
instructions on how to proceed. Note that parties cannot directly communicate
with each other, rather, all communication passes through $\mc{A}$. If the
network is synchronous, then $\mc{A}$ is not allowed to interfere with network
traffic. If the network if asynchronous, $\mc{A}$ is allowed to delay and
reorder messages arbitrarily.

Let $\phi$ denote the ideal protocol followed by a set of parties relying on the
ideal functionality $\mc{F}$, and let $\mc{S}$ denote an ideal adversary, also
known as a \emph{simulator}, that aims to break the security of $\phi$. Here, the
parties are \emph{dummy parties}, since they hand received inputs directly to
$\mc{F}$ for processing, and output whatever is directly returned by
$\mc{F}$. Clearly, since the dummy parties do nothing, and $\mc{F}$ is secure by
definition, it makes sense to define $\phi$ as secure.

The goal of the environment $\mc{Z}$ is to distinguish between the real protocol
and the ideal protocol. Since in the real protocol, $\mc{Z}$ interacts with the
adversary $\mc{A}$, in the ideal protocol, $\mc{Z}$ interacts with the simulator
$\mc{S}$. The job of $\mc{S}$ is to pretend to be $\mc{A}$ with the aid of
$\mc{F}$. The amount of help $\mc{F}$ is able to provide is specified in
$\mc{F}$ itself.

\section{ILC}\label{sec:ilc}

\begin{definition}[Protocol Emulation]
Let $\pi$ and $\phi$ be probabilistic polynomial time (p.p.t) protocols. We say
that $\pi$ UC-emulates $\phi$ if for any p.p.t. adversary $\mc{A}$ there exists a
p.p.t. ideal-process adversary $\mc{S}$ such that for any balanced PPT environment
$\mc{Z}$ we have:
\begin{equation*}
\textsc{Exec}_{\phi, \mc{S}, \mc{Z}} \approx \textsc{Exec}_{\pi, \mc{A}, \mc{Z}}.
\end{equation*}
\end{definition}

\begin{definition}[Protocol Emulation w.r.t. the Dummy Adversary]
Let $\pi$ and $\phi$ be probabilistic polynomial time (p.p.t) protocols. We say
that $\pi$ UC-emulates $\phi$ if for the dummy adversary $\mc{D}$ there exists a
p.p.t. ideal-process adversary $\mc{S}$ such that for any balanced PPT environment
$\mc{Z}$ we have:
\begin{equation*}
\textsc{Exec}_{\phi, \mc{S}, \mc{Z}} \approx \textsc{Exec}_{\pi, \mc{D}, \mc{Z}}.
\end{equation*}
\end{definition}

\begin{comment}
Let {\sf Bit} be the type of single bits (i.e., 0 or 1), and let {\sf Inf} be
the type of infinite bitstrings. The meaning of an ILC term $\tau$ is given by the
denotation $[\![\tau]\!]\sigma$, which returns, for an infinite bitstring $\sigma{:}{\sf Inf}$, a value
$v{:}{\sf Bit}$. The denotation $[\![\tau]\!]$, then, returns a binary
distribution $d$ over the types of return values for all infinite
bitstrings. Let $\Delta(d_1, d_2)$ denote the statistical distance between two
distributions $d_1$ and $d_2$.
%\[ \Delta(d_1, d_2) \defeq max_{A}|d_1 A - d_2 A|\]


\begin{definition}[$\epsilon$-indistinguishability of ILC Terms]
Let $\tau_1$ and $\tau_2$ be ILC terms, which are closed except for an infinite
bitstream free variable $\sigma{:}{\sf Inf}$. Additionally, for any such $\sigma$,
$[\![t_1]\!]\sigma{:}{\sf Bit}$ and $[\![\tau_2]\!]\sigma{:}{\sf Bit}$. We say that $\tau_1$ and
$\tau_2$ are $\epsilon$-indistinguishable iff $\Delta([\![\tau_1]\!], [\![\tau_2]\!]) \leq \epsilon$.
\end{definition}
\end{comment}

\begin{definition}[Probability Distribution Ensemble]
An \emph{ensemble} of probability distributions is a family of probability
distributions $\{ X_n \}_{n \in \mathbb{N}}$ ($\{ X_n \}_n$ for short) with index
set $\mathbb{N}$.  The ensembles considered in this work are binary probability
distribution ensembles, which describe single bit outputs of computations, where
$n \in \mathbb{N}$ represents the security parameter.
\end{definition}

\begin{definition}[Indistinguishability]
Let $\{X_n\}_n$ and $\{ Y_n \}_n$ be two binary probability distribution
ensembles. We say that $\{ X_n \}_n$ and $\{ Y_n \}_n$ are indistinguishable
(written $\{ X_n \}_n \approx \{ Y_n \}_n$) if for any $c \in \mathbb{N}$, there exists
$k_0 \in \mathbb{N}$ such that for all $k > k_0$,
\[ | \Pr[X_k = 1] - \Pr[Y_k = 1] | < k^{-c}. \]
\end{definition}

\begin{definition}[Bit Producing ILC Term]
Let $\tau$ be an ILC term. We say that $\tau$ is bit producing if it is closed except
for an infinite bitstream free variable $\sigma{:}{\sf Inf}$ and $\sigma{:}{\sf Inf} \vdash
\tau{:}{\sf Bit}$.

\end{definition}

\begin{definition}[Indistinguishability of Bit Producing ILC Terms]
Let $\tau_1$ and $\tau_2$ be bit producing ILC terms. We say that $\tau_1$ and $\tau_2$ are
indistinguishable terms if the binary probability distribution ensembles
$[\![\tau_1]\!]$ and $[\![\tau_2]\!]$ are indistinguishable.
\end{definition}

\begin{definition}[Protocol Emulation in ILC]
Let $(\pi_1, \mc{F}_1)$ and $(\pi_2, \mc{F}_2)$ be two protocol-functionality
pairs. We say that $(\pi_1, \mc{F}_1)$ UC-emulates $(\pi_2, \mc{F}_2)$ iff for all
adversaries $\mc{A}$, there exists an ideal-process adversary $\mc{S}$ such that
for any environment $\mc{Z}$,
$\textsc{ExecUC}_{\mc{Z}, \mc{A}, \pi_1, \mc{F}_1}$ and
$\textsc{ExecUC}_{\mc{Z}, \mc{S}, \pi_2, \mc{F}_2}$ are bit producing and
indistinguishable terms.
\end{definition}

\begin{definition}[Protocol Emulation in ILC]
Let $\pi$ and $\phi$ be probabilistic polynomial time (p.p.t.) protocols. We say that
$\pi$ UC-emulates $\phi$ if for any p.p.t. adversary 
$\mc{A}$, there exists a p.p.t. ideal-process adversary $\mc{S}$
such that for any balanced p.p.t. environment $\mc{Z}$,
$\textsc{ExecUC}_{\phi, \mc{S}, \mc{Z}}$ and $\textsc{ExecUC}_{\pi, \mc{A}, \mc{Z}}$
are indistinguishable bit producing terms.
\end{definition}

\begin{definition}[Balanced Environment]
An environment $\mc{Z}$ is balanced if the overall length of inputs given by
$\mc{Z}$ to the parties of the main instance $\pi$ is at most $k$ times the length
of the input to the adversary.
\end{definition}


\section{Metatheory}\label{sec:metatheory}

\begin{enumerate}
\item Type soundness
\item Confluence
\end{enumerate}

\section{Implementation}\label{sec:implementation}

\begin{enumerate}
\item Bidirectional type checker
\item Replication
\end{enumerate}

\section{Experiments}\label{sec:experiments}

\input{execuc}

\begin{enumerate}
\item Impossibility of UC commitments using standard
assumptions~\cite{canetti2001commitments}.
\item UC commitments construction using CRS
\end{enumerate}

\begin{func}[COM]
    $\Func_{\textsc{COM}}$ proceeds as follows, running with parties $P_1, \ldots, P_n$ and an adversary $S$.
    \begin{enumerate}
        \item Upon receiving a value $({\sf Commit}, sid, P_i, P_j, b)$ from
          $P_i$, where $b \in \{ 0, 1 \}$, record the value $b$ and send the
          message $({\sf Receipt}, sid, P_i, P_j)$ to $P_j$ and $S$. Ignore any
          subsequent {\sf Commit} messages.

        \item Upon receiving a value $({\sf Open}, sid, P_i, P_j)$ from $P_i$,
          proceed as follows: If some value $b$ was previously recorded, then
          send the message $({\sf Open}, sid, P_i, P_j, b)$ to $P_j$ and $S$ and halt. Otherwise halt.
    \end{enumerate}
\end{func}

\lstinputlisting[style=ilc]{listings/F_com.ilc}

\section{Related Work}
EasyCrypt~\cite{barthe2011computer}, CertiCrypt~\cite{barthe2009formal},
CryptoVerif~\cite{blanchet2007cryptoverif},
ProVerif~\cite{blanchet2005proverif}, RF*~\cite{barthe2014probabilistic},
Cryptol~\cite{lewis2003cryptol}, code-based game-playing
proofs~\cite{bellare2006security}, symbolic UC~\cite{bohl2016symbolic}
\section{Conclusion}

\section{Future Work}

%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{bibfile}


%% Appendix
\appendix
\section{Appendix}

\begin{figure}[htbp]
  \centering

\begin{grammar}
  Value Types
  & $A,B$
      &$\bnfas$&
      $x$ & Value variable
      \\ &&& $\bnfaltbrk \Unit$ & Unit value
      \\ &&& $\bnfaltbrk \Nat$         & Natural number
      \\ &&& $\bnfaltbrk A ** B$ & Product
      \\ &&& $\bnfaltbrk A + B$ & Sum type
      \\ &&& $\bnfaltbrk *! A$ & Intuitionistic type
      \\ &&& $\bnfaltbrk \tyRd{A}$ & Read channel
      \\ &&& $\bnfaltbrk \tyWr{A}$ & Write channel
      \\ &&& $\bnfaltbrk \tyU{C}$ & Thunk type
  \\[1ex]
  Computation Types
  & $C, D$
      &$\bnfas$ & 
             $A -> C$ & Value-consuming computation
      \\ &&& $\bnfaltbrk \tyF{A}$ & Value-producing computation
  \\[1ex]
  Linear Typing Contexts
  & $\Delta$
     &$\bnfas$& $\emptyctxt \bnfalt \Delta,x:A$
  \\
  Intuitionisitic Typing Contexts
  & $\Gamma$
     &$\bnfas$& $\emptyctxt \bnfalt \Gamma,x:A$
\end{grammar}

  \caption{Syntax of types and typing contexts}
  \label{fig:expr}
\end{figure}


\begin{figure}[htbp]
  \centering

\begin{grammar}
  Values
  & $v$
      &$\bnfas$&
      $x$
      \\ &&& $\bnfaltbrk \vUnit$ & Unit value
      \\ &&& $\bnfaltbrk n$         & Natural number
      \\ &&& $\bnfaltbrk \vPair{v_1}{v_2}$ & Pair of values
      \\ &&& $\bnfaltbrk \vInj{i}{v}$ & Injected value
      \\ &&& $\bnfaltbrk \vChan{c}$ & Channel (either read or write end)
      \\ &&& $\bnfaltbrk \vThunk{e}$ & Thunk (suspended, closed expression)
  \\[1ex]
  Expressions
  & $e$
      &$\bnfas$&
             $\Split{v}{x_1}{x_2}{e}$ & Pair elimination
      \\ &&& $\bnfaltbrk \Case{v}{x_1}{e_1}{x_2}{e_2}$ & Injection elimination
      \\ &&& $\bnfaltbrk \Ret{v}$ & Value-producing computation
      \\ &&& $\bnfaltbrk \Let{e_1}{x}{e_2}$ & Let-binding/sequencing
      \\ &&& $\bnfaltbrk \eApp{e}{v}$ & Function application
      \\ &&& $\bnfaltbrk \lam{x} e$ & Function abstraction
      \\ &&& $\bnfaltbrk \eForce{v}$ & Unsuspend (force) a thunk
      \\ &&& $\bnfaltbrk \eWr{v_1}{v_2}$ & Write channel~$v_1$ with value~$v_2$
      \\ &&& $\bnfaltbrk \eRd{v}$ & Read channel~$v$
      \\ &&& $\bnfaltbrk \eNu{x}{e}$ & Allocate channel as~$x$ in~$e$      \\ &&& $\bnfaltbrk e_1 *&& e_2$ & Fork~$e_1$, continue as~$e_2$
      \\ &&& $\bnfaltbrk e_1 *|| e_2$ & External choice between~$e_1$ and~$e_2$
\end{grammar}

  \caption{Syntax of values and expressions}
  \label{fig:expr}
\end{figure}


\begin{figure}[htbp]
{
  \centering

\begin{grammar}
  Modes & $m,n,p$ &$\bnfas$& $\Wm \bnfalt \Rm \bnfalt \Vm$ & (Write, Read and Value) 
\end{grammar}

\judgbox{m || n => p}{~~The parallel composition of modes $m$ and $n$ is mode~$p$.}
\begin{mathpar}
\Infer{sym}{m || n => p}{n || m => p}
\and \Infer{wv}{ }{\Wm || \Vm => \Wm}
\and \Infer{wr}{ }{\Wm || \Rm => \Wm}
\and \Infer{rr}{ }{\Rm || \Rm => \Rm}
\end{mathpar}
\\[2mm]
\judgbox{m ;; n => p}{~~The sequential composition of modes $m$ and $n$ is mode~$p$.}
\begin{mathpar}
\and \Infer{v$\ast$}{ }{\Vm ;; n => n}
\and \Infer{wv}{ }{\Wm ;; \Vm => \Wm}
\and \Infer{r$\ast$}{ }{\Rm ;; n => \Rm}
\and \Infer{wr}{ }{\Wm ;; \Rm => \Wm}
\end{mathpar}
}
Note that in particular, the following mode compositions are \emph{not derivable}:
\begin{itemize}
\item $\Wm || \Wm => p$ is \emph{not} derivable for any mode~$p$
\item $\Wm ;; \Wm => p$ is \emph{not} derivable for any mode~$p$
\end{itemize}
\caption{Syntax of modes; sequential and parallel mode composition.}
\label{fig:expr}
\end{figure}


\begin{figure}[htbp]
\centering
\judgbox{\Delta ; \Gamma |- e : C |> m}{~~Under $\Delta$ and $\Gamma$, expression~$e$ has type $C$ and mode $m$.}
\begin{mathpar}
%
\Infer{ret}
{\Delta ; \Gamma |- v : A}
{\Delta ; \Gamma |- \Ret{v} : \tyF A |> \Vm}
%
\and
%
\Infer{let}
{ m_1 ;; m_2 => m_3\\\\
\Delta_1        ; \Gamma |- e_1 : \tyF A |> m_1 \\\\
 \Delta_2, x:A ; \Gamma |- e_2 : C |> m_2
}
{\Delta_1, \Delta_2 ; \Gamma, x:A |- \Let{e_1}{x}{e_2} : C |> m_3}
%
\and
%
\Infer{ret!}
{\emptyctxt ; \Gamma |- v : A}
{\emptyctxt ; \Gamma |- \Ret{v} : \tyF (*! A) |> \Vm}
%
\and
%
\Infer{let!}
{\Delta_1 ; \Gamma |- v : *! A \\
 \Delta_2 ; \Gamma, x : A |- e : C |> m }
{\Delta_1, \Delta_2 ; \Gamma, x : A |- \LetBang{v}{x}{e} : C |> m}
%
\and
%
\Infer{lam}
{\Delta ; \Gamma |-         e :      C |> m}
{\Delta ; \Gamma |- \lam{x} e : A -> C |> m}
%
\and
%
\Infer{app}
{\Delta_1 ; \Gamma |- v : A \\
 \Delta_2 ; \Gamma |- e : A -> C |> m}
{\Delta_1, \Delta_2 ; \Gamma |- e\,v : C |> m}
%
\and
%
\Infer{nu}
{\Delta, x:\big(\tyRd A ** *!(\tyWr A)\big) ; \Gamma |- e : C |> m}
{\Delta                                 ; \Gamma |- \eNu{x}{e} : C |> m}
%
\\
%
\Infer{rd}
{\Delta; \Gamma |- v : \tyRd A}
{\Delta         |- \eRd{v} : \tyF (A ** (\tyRd A)) |> \Rm}
%
\and
%
\Infer{wr}
{\Delta_1; \Gamma   |- v_1 : \tyWr A \\
 \Delta_2; \Gamma   |- v_2 : A }
{\Delta_1, \Delta_2 |- \eWr{v_1}{v_2} : \tyF \Unit |> \Wm}
%
\\
%
\Infer{fork}
{
 m_1 || m_2 => m_3
 \\\\
 \Delta_1; \Gamma |- e_1 : C |> m_1
 \\\\
 \Delta_2; \Gamma |- e_2 : D |> m_2
}
{\Delta_1, \Delta_2 |- e_1 \xFork e_2 : D |> m_3}
%
\and
%
\Infer{choice}
{\Delta_1; \Gamma |- e_1 : C |> \Rm
           \\\\
 \Delta_2; \Gamma |- e_2 : C |> \Rm
}
{\Delta_1, \Delta_2 |- e_1 *|| e_2 : C |> \Rm}
%
\end{mathpar}
\end{figure}


\begin{figure}
\centering
\begin{grammar}
  Channels
  & $\Chans$ 
    & $\bnfas$ & $\emptyChans ~|~ \Chans, c$
    \\[2mm]
  Process pool
  & $\Procs$ 
    & $\bnfas$ & $\emptyProcs ~|~ \Procs, \proc$
    \\[2mm]
  Configurations
  & $C$
     & $\bnfas$ & $\Config{\Chans}{\Procs} $
     \\[2mm]
 Evaluation contexts
  & $E$
     & $\bnfas$ & $\Let{E}{x}{e}$
     \\ &&& $\bnfaltbrk \App{E}{v}$
     \\ &&& $\bnfaltbrk \bullet$
\\[2mm]
 Read contexts
  & $R$
     & $\bnfas$ & $\eRd{\vChan{c}} \oplus R$
     \\ &&& $\bnfaltbrk R \oplus \eRd{\vChan{c}}$
     \\ &&& $\bnfaltbrk \bullet$
\end{grammar}

\judgbox{e ---> e'}{~~Expression~$e_1$ reduces to~$e_2$.}
\begin{mathpar}
\Infer{let}
{}
{ \Let{\Ret{v}}{x}{e} ---> [v/x]e }
~~~
\Infer{app}
{}
{ \eApp{(\lam{x} e)}{v} ---> [v/x]e }
~~~
\Infer{force}
{ }
{ \eForce{\vThunk{e}} ---> e }
\and
\Infer{split}
{ }
{ \eSplit{\vPair{v_1}{v_2}}{x}{y}{e} ---> [v_1/x][v_2/y]e }
~~~
\Infer{case}
{ }
{ \eCase{\vInj{i}{v}}{x_1}{e_1}{x_2}{e_2} ---> e_i[v/x_i] }
\end{mathpar}

\judgbox{C_1 \equiv C_2}{~~Configurations~$C_1$ and $C_2$ are equivalent.}
\begin{mathpar}
\Infer{permProcs}
{  \Procs_1 \equiv_\textsf{perm} \Procs_2 }
{ \Config{\Chans}{\Procs_1} \equiv \Config{\Chans}{\Procs_2} }
\end{mathpar}

\judgbox{C_1 ---> C_2}{~~Configuration~$C_1$ reduces to $C_2$.}
\begin{mathpar}
\Infer{local}{ e ---> e' }
{ \Config{\Chans}{\Procs, E[e]} ---> \Config{\Chans}{\Procs, E[e]'} }
~~~
\Infer{fork}{ ~ }
{ \Config{\Chans}{\Procs, E[ e_1 \xFork e_2 ] } ---> \Config{\Chans}{\Procs, e_1, E[ e_2 ] } }
\and
\Infer{congr}{
C_1 \equiv C_1' 
\\
C_1' ---> C_2
\\
C_2 \equiv C_2'
}
{ C_1 ---> C_2' }
\and
\Infer{nu}{ c \notin \Chans }
{ \Config{\Chans}{\Procs,E[\eNu{x}{e}]} ---> \Config{\Chans, c}{\Procs, E[ [\vPair{\vChan{c}}{\vChan{c}} / x] e ]} }
\and
\Infer{rw}{ ~ }
{ \Config{\Chans}{\Procs,E_1[R[\eRd{\vChan{c}}] ],E_2[\eWr{\vChan{c}}{v}]} ---> \Config{\Chans}{\Procs,E_1[v],E_2[\vUnit]} }
\and
\end{mathpar}
\end{figure}

\end{document}
